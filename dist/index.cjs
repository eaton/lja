"use strict";var _=Object.defineProperty;var g=(r,e)=>_(r,"name",{value:e,configurable:!0});var M=require("@sindresorhus/is"),L=require("@thi.ng/leb128"),n=require("zod"),H=require("dayjs"),J=require("fast-xml-parser");function X(r){var e=Object.create(null);return r&&Object.keys(r).forEach(function(t){if(t!=="default"){var s=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:function(){return r[t]}})}}),e.default=r,Object.freeze(e)}g(X,"_interopNamespaceDefault");var G=X(L);class K{static{g(this,"Context")}code="";scopes=[["vars"]];bitFields=[];tmpVariableCount=0;references=new Map;importPath;imports=[];reverseImports=new Map;useContextVariables=!1;constructor(e,t){this.importPath=e,this.useContextVariables=t}generateVariable(e){const t=[...this.scopes[this.scopes.length-1]];return e&&t.push(e),t.join(".")}generateOption(e){switch(typeof e){case"number":return e.toString();case"string":return this.generateVariable(e);case"function":return`${this.addImport(e)}.call(${this.generateVariable()}, vars)`}}generateError(e){this.pushCode(`throw new Error(${e});`)}generateTmpVariable(){return"$tmp"+this.tmpVariableCount++}pushCode(e){this.code+=e+`
`}pushPath(e){e&&this.scopes[this.scopes.length-1].push(e)}popPath(e){e&&this.scopes[this.scopes.length-1].pop()}pushScope(e){this.scopes.push([e])}popScope(){this.scopes.pop()}addImport(e){if(!this.importPath)return`(${e})`;let t=this.reverseImports.get(e);return t||(t=this.imports.push(e)-1,this.reverseImports.set(e,t)),`${this.importPath}[${t}]`}addReference(e){this.references.has(e)||this.references.set(e,{resolved:!1,requested:!1})}markResolved(e){const t=this.references.get(e);t&&(t.resolved=!0)}markRequested(e){e.forEach(t=>{const s=this.references.get(t);s&&(s.requested=!0)})}getUnresolvedReferences(){return Array.from(this.references).filter(([e,t])=>!t.resolved&&!t.requested).map(([e,t])=>e)}}const m=new Map,w="___parser_",c={uint8:1,uint16le:2,uint16be:2,uint32le:4,uint32be:4,int8:1,int16le:2,int16be:2,int32le:4,int32be:4,int64be:8,int64le:8,uint64be:8,uint64le:8,floatle:4,floatbe:4,doublele:8,doublebe:8},E={uint8:"Uint8",uint16le:"Uint16",uint16be:"Uint16",uint32le:"Uint32",uint32be:"Uint32",int8:"Int8",int16le:"Int16",int16be:"Int16",int32le:"Int32",int32be:"Int32",int64be:"BigInt64",int64le:"BigInt64",uint64be:"BigUint64",uint64le:"BigUint64",floatle:"Float32",floatbe:"Float32",doublele:"Float64",doublebe:"Float64"},I={uint8:!1,uint16le:!0,uint16be:!1,uint32le:!0,uint32be:!1,int8:!1,int16le:!0,int16be:!1,int32le:!0,int32be:!1,int64be:!1,int64le:!0,uint64be:!1,uint64le:!0,floatle:!0,floatbe:!1,doublele:!0,doublebe:!1};class a{static{g(this,"Parser")}varName="";type="";options={};next;head;compiled;endian="be";constructorFn;alias;useContextVariables=!1;constructor(){}static start(){return new a}primitiveGenerateN(e,t){const s=E[e],i=I[e];t.pushCode(`${t.generateVariable(this.varName)} = dataView.get${s}(offset, ${i});`),t.pushCode(`offset += ${c[e]};`)}primitiveN(e,t,s){return this.setNextParser(e,t,s)}useThisEndian(e){return e+this.endian.toLowerCase()}uint8(e,t={}){return this.primitiveN("uint8",e,t)}uint16(e,t={}){return this.primitiveN(this.useThisEndian("uint16"),e,t)}uint16le(e,t={}){return this.primitiveN("uint16le",e,t)}uint16be(e,t={}){return this.primitiveN("uint16be",e,t)}uint32(e,t={}){return this.primitiveN(this.useThisEndian("uint32"),e,t)}uint32le(e,t={}){return this.primitiveN("uint32le",e,t)}uint32be(e,t={}){return this.primitiveN("uint32be",e,t)}int8(e,t={}){return this.primitiveN("int8",e,t)}int16(e,t={}){return this.primitiveN(this.useThisEndian("int16"),e,t)}int16le(e,t={}){return this.primitiveN("int16le",e,t)}int16be(e,t={}){return this.primitiveN("int16be",e,t)}int32(e,t={}){return this.primitiveN(this.useThisEndian("int32"),e,t)}int32le(e,t={}){return this.primitiveN("int32le",e,t)}int32be(e,t={}){return this.primitiveN("int32be",e,t)}bigIntVersionCheck(){if(!DataView.prototype.getBigInt64)throw new Error("BigInt64 is unsupported on this runtime")}int64(e,t={}){return this.bigIntVersionCheck(),this.primitiveN(this.useThisEndian("int64"),e,t)}int64be(e,t={}){return this.bigIntVersionCheck(),this.primitiveN("int64be",e,t)}int64le(e,t={}){return this.bigIntVersionCheck(),this.primitiveN("int64le",e,t)}uint64(e,t={}){return this.bigIntVersionCheck(),this.primitiveN(this.useThisEndian("uint64"),e,t)}uint64be(e,t={}){return this.bigIntVersionCheck(),this.primitiveN("uint64be",e,t)}uint64le(e,t={}){return this.bigIntVersionCheck(),this.primitiveN("uint64le",e,t)}floatle(e,t={}){return this.primitiveN("floatle",e,t)}floatbe(e,t={}){return this.primitiveN("floatbe",e,t)}doublele(e,t={}){return this.primitiveN("doublele",e,t)}doublebe(e,t={}){return this.primitiveN("doublebe",e,t)}bitN(e,t,s){return s.length=e,this.setNextParser("bit",t,s)}bit1(e,t={}){return this.bitN(1,e,t)}bit2(e,t={}){return this.bitN(2,e,t)}bit3(e,t={}){return this.bitN(3,e,t)}bit4(e,t={}){return this.bitN(4,e,t)}bit5(e,t={}){return this.bitN(5,e,t)}bit6(e,t={}){return this.bitN(6,e,t)}bit7(e,t={}){return this.bitN(7,e,t)}bit8(e,t={}){return this.bitN(8,e,t)}bit9(e,t={}){return this.bitN(9,e,t)}bit10(e,t={}){return this.bitN(10,e,t)}bit11(e,t={}){return this.bitN(11,e,t)}bit12(e,t={}){return this.bitN(12,e,t)}bit13(e,t={}){return this.bitN(13,e,t)}bit14(e,t={}){return this.bitN(14,e,t)}bit15(e,t={}){return this.bitN(15,e,t)}bit16(e,t={}){return this.bitN(16,e,t)}bit17(e,t={}){return this.bitN(17,e,t)}bit18(e,t={}){return this.bitN(18,e,t)}bit19(e,t={}){return this.bitN(19,e,t)}bit20(e,t={}){return this.bitN(20,e,t)}bit21(e,t={}){return this.bitN(21,e,t)}bit22(e,t={}){return this.bitN(22,e,t)}bit23(e,t={}){return this.bitN(23,e,t)}bit24(e,t={}){return this.bitN(24,e,t)}bit25(e,t={}){return this.bitN(25,e,t)}bit26(e,t={}){return this.bitN(26,e,t)}bit27(e,t={}){return this.bitN(27,e,t)}bit28(e,t={}){return this.bitN(28,e,t)}bit29(e,t={}){return this.bitN(29,e,t)}bit30(e,t={}){return this.bitN(30,e,t)}bit31(e,t={}){return this.bitN(31,e,t)}bit32(e,t={}){return this.bitN(32,e,t)}namely(e){return m.set(e,this),this.alias=e,this}skip(e,t={}){return this.seek(e,t)}seek(e,t={}){if(t.assert)throw new Error("assert option on seek is not allowed.");return this.setNextParser("seek","",{length:e})}string(e,t){if(!t.zeroTerminated&&!t.length&&!t.greedy)throw new Error("One of length, zeroTerminated, or greedy must be defined for string.");if((t.zeroTerminated||t.length)&&t.greedy)throw new Error("greedy is mutually exclusive with length and zeroTerminated for string.");if(t.stripNull&&!(t.length||t.greedy))throw new Error("length or greedy must be defined if stripNull is enabled.");return t.encoding=t.encoding||"utf8",this.setNextParser("string",e,t)}buffer(e,t){if(!t.length&&!t.readUntil)throw new Error("length or readUntil must be defined for buffer.");return this.setNextParser("buffer",e,t)}wrapped(e,t){if(typeof t!="object"&&typeof e=="object"&&(t=e,e=""),!t||!t.wrapper||!t.type)throw new Error("Both wrapper and type must be defined for wrapped.");if(!t.length&&!t.readUntil)throw new Error("length or readUntil must be defined for wrapped.");return this.setNextParser("wrapper",e,t)}array(e,t){if(!t.readUntil&&!t.length&&!t.lengthInBytes)throw new Error("One of readUntil, length and lengthInBytes must be defined for array.");if(!t.type)throw new Error("type is required for array.");if(typeof t.type=="string"&&!m.has(t.type)&&!(t.type in c))throw new Error(`Array element type "${t.type}" is unknown.`);return this.setNextParser("array",e,t)}choice(e,t){if(typeof t!="object"&&typeof e=="object"&&(t=e,e=""),!t)throw new Error("tag and choices are are required for choice.");if(!t.tag)throw new Error("tag is requird for choice.");if(!t.choices)throw new Error("choices is required for choice.");for(const s in t.choices){const i=parseInt(s,10),o=t.choices[i];if(isNaN(i))throw new Error(`Choice key "${s}" is not a number.`);if(typeof o=="string"&&!m.has(o)&&!(o in c))throw new Error(`Choice type "${o}" is unknown.`)}return this.setNextParser("choice",e,t)}nest(e,t){if(typeof t!="object"&&typeof e=="object"&&(t=e,e=""),!t||!t.type)throw new Error("type is required for nest.");if(!(t.type instanceof a)&&!m.has(t.type))throw new Error("type must be a known parser name or a Parser object.");if(!(t.type instanceof a)&&!e)throw new Error("type must be a Parser object if the variable name is omitted.");return this.setNextParser("nest",e,t)}pointer(e,t){if(t.offset==null)throw new Error("offset is required for pointer.");if(!t.type)throw new Error("type is required for pointer.");if(typeof t.type=="string"&&!(t.type in c)&&!m.has(t.type))throw new Error(`Pointer type "${t.type}" is unknown.`);return this.setNextParser("pointer",e,t)}saveOffset(e,t={}){return this.setNextParser("saveOffset",e,t)}endianness(e){switch(e.toLowerCase()){case"little":this.endian="le";break;case"big":this.endian="be";break;default:throw new Error('endianness must be one of "little" or "big"')}return this}endianess(e){return this.endianness(e)}useContextVars(e=!0){return this.useContextVariables=e,this}create(e){if(!(e instanceof Function))throw new Error("Constructor must be a Function object.");return this.constructorFn=e,this}getContext(e){const t=new K(e,this.useContextVariables);return t.pushCode("var dataView = new DataView(buffer.buffer, buffer.byteOffset, buffer.length);"),this.alias?(this.addAliasedCode(t),t.pushCode(`return ${w+this.alias}(0).result;`)):this.addRawCode(t),t}getCode(){return this.getContext("imports").code}addRawCode(e){e.pushCode("var offset = 0;"),e.pushCode(`var vars = ${this.constructorFn?"new constructorFn()":"{}"};`),e.pushCode("vars.$parent = null;"),e.pushCode("vars.$root = vars;"),this.generate(e),this.resolveReferences(e),e.pushCode("delete vars.$parent;"),e.pushCode("delete vars.$root;"),e.pushCode("return vars;")}addAliasedCode(e){return e.pushCode(`function ${w+this.alias}(offset, context) {`),e.pushCode(`var vars = ${this.constructorFn?"new constructorFn()":"{}"};`),e.pushCode("var ctx = Object.assign({$parent: null, $root: vars}, context || {});"),e.pushCode("vars = Object.assign(vars, ctx);"),this.generate(e),e.markResolved(this.alias),this.resolveReferences(e),e.pushCode("Object.keys(ctx).forEach(function (item) { delete vars[item]; });"),e.pushCode("return { offset: offset, result: vars };"),e.pushCode("}"),e}resolveReferences(e){const t=e.getUnresolvedReferences();e.markRequested(t),t.forEach(s=>{m.get(s)?.addAliasedCode(e)})}compile(){const e="imports",t=this.getContext(e);this.compiled=new Function(e,"TextDecoder",`return function (buffer, constructorFn) { ${t.code} };`)(t.imports,TextDecoder)}sizeOf(){let e=NaN;if(Object.keys(c).indexOf(this.type)>=0)e=c[this.type];else if(this.type==="string"&&typeof this.options.length=="number")e=this.options.length;else if(this.type==="buffer"&&typeof this.options.length=="number")e=this.options.length;else if(this.type==="array"&&typeof this.options.length=="number"){let t=NaN;typeof this.options.type=="string"?t=c[this.options.type]:this.options.type instanceof a&&(t=this.options.type.sizeOf()),e=this.options.length*t}else this.type==="seek"?e=this.options.length:this.type==="nest"?e=this.options.type.sizeOf():this.type||(e=0);return this.next&&(e+=this.next.sizeOf()),e}parse(e){return this.compiled||this.compile(),this.compiled(e,this.constructorFn)}setNextParser(e,t,s){const i=new a;return i.type=e,i.varName=t,i.options=s,i.endian=this.endian,this.head?this.head.next=i:this.next=i,this.head=i,this}generate(e){if(this.type){switch(this.type){case"uint8":case"uint16le":case"uint16be":case"uint32le":case"uint32be":case"int8":case"int16le":case"int16be":case"int32le":case"int32be":case"int64be":case"int64le":case"uint64be":case"uint64le":case"floatle":case"floatbe":case"doublele":case"doublebe":this.primitiveGenerateN(this.type,e);break;case"bit":this.generateBit(e);break;case"string":this.generateString(e);break;case"buffer":this.generateBuffer(e);break;case"seek":this.generateSeek(e);break;case"nest":this.generateNest(e);break;case"array":this.generateArray(e);break;case"choice":this.generateChoice(e);break;case"pointer":this.generatePointer(e);break;case"saveOffset":this.generateSaveOffset(e);break;case"wrapper":this.generateWrapper(e);break}this.type!=="bit"&&this.generateAssert(e)}const t=e.generateVariable(this.varName);return this.options.formatter&&this.type!=="bit"&&this.generateFormatter(e,t,this.options.formatter),this.generateNext(e)}generateAssert(e){if(!this.options.assert)return;const t=e.generateVariable(this.varName);switch(typeof this.options.assert){case"function":{const s=e.addImport(this.options.assert);e.pushCode(`if (!${s}.call(vars, ${t})) {`)}break;case"number":e.pushCode(`if (${this.options.assert} !== ${t}) {`);break;case"string":e.pushCode(`if (${JSON.stringify(this.options.assert)} !== ${t}) {`);break;default:throw new Error("assert option must be a string, number or a function.")}e.generateError(`"Assertion error: ${t} is " + ${JSON.stringify(this.options.assert.toString())}`),e.pushCode("}")}generateNext(e){return this.next&&(e=this.next.generate(e)),e}nextNotBit(){return this.next?this.next.type==="nest"?this.next.options&&this.next.options.type instanceof a?this.next.options.type.next?this.next.options.type.next.type!=="bit":!1:!0:this.next.type!=="bit":!0}generateBit(e){const t=JSON.parse(JSON.stringify(this));if(t.options=this.options,t.generateAssert=this.generateAssert.bind(this),t.generateFormatter=this.generateFormatter.bind(this),t.varName=e.generateVariable(t.varName),e.bitFields.push(t),!this.next||this.nextNotBit()){const s=e.generateTmpVariable();e.pushCode(`var ${s} = 0;`);const i=g((u=0)=>{let b=0;for(let y=u;y<e.bitFields.length;y++){const k=e.bitFields[y].options.length;if(b+k>32)break;b+=k}return b},"getMaxBits"),o=g(u=>(u<=8?(e.pushCode(`${s} = dataView.getUint8(offset);`),u=8):u<=16?(e.pushCode(`${s} = dataView.getUint16(offset);`),u=16):u<=24?(e.pushCode(`${s} = (dataView.getUint16(offset) << 8) | dataView.getUint8(offset + 2);`),u=24):(e.pushCode(`${s} = dataView.getUint32(offset);`),u=32),e.pushCode(`offset += ${u/8};`),u),"getBytes");let p=0;const h=this.endian==="be";let d=0,l=0;e.bitFields.forEach((u,b)=>{let y=u.options.length;if(y>l){if(l){const q=-1>>>32-l;e.pushCode(`${u.varName} = (${s} & 0x${q.toString(16)}) << ${y-l};`),y-=l}p=0,l=d=o(i(b)-l)}const k=h?d-p-y:p,D=-1>>>32-y;e.pushCode(`${u.varName} ${y<u.options.length?"|=":"="} ${s} >> ${k} & 0x${D.toString(16)};`),u.options.length===32&&e.pushCode(`${u.varName} >>>= 0`),u.options.assert&&u.generateAssert(e),u.options.formatter&&u.generateFormatter(e,u.varName,u.options.formatter),p+=y,l-=y}),e.bitFields=[]}}generateSeek(e){const t=e.generateOption(this.options.length);e.pushCode(`offset += ${t};`)}generateString(e){const t=e.generateVariable(this.varName),s=e.generateTmpVariable(),i=this.options.encoding,o=i.toLowerCase()==="hex",p='b => b.toString(16).padStart(2, "0")';if(this.options.length&&this.options.zeroTerminated){const h=this.options.length;e.pushCode(`var ${s} = offset;`),e.pushCode(`while(dataView.getUint8(offset++) !== 0 && offset - ${s} < ${h});`);const d=`offset - ${s} < ${h} ? offset - 1 : offset`;e.pushCode(o?`${t} = Array.from(buffer.subarray(${s}, ${d}), ${p}).join('');`:`${t} = new TextDecoder('${i}').decode(buffer.subarray(${s}, ${d}));`)}else if(this.options.length){const h=e.generateOption(this.options.length);e.pushCode(o?`${t} = Array.from(buffer.subarray(offset, offset + ${h}), ${p}).join('');`:`${t} = new TextDecoder('${i}').decode(buffer.subarray(offset, offset + ${h}));`),e.pushCode(`offset += ${h};`)}else this.options.zeroTerminated?(e.pushCode(`var ${s} = offset;`),e.pushCode("while(dataView.getUint8(offset++) !== 0);"),e.pushCode(o?`${t} = Array.from(buffer.subarray(${s}, offset - 1), ${p}).join('');`:`${t} = new TextDecoder('${i}').decode(buffer.subarray(${s}, offset - 1));`)):this.options.greedy&&(e.pushCode(`var ${s} = offset;`),e.pushCode("while(buffer.length > offset++);"),e.pushCode(o?`${t} = Array.from(buffer.subarray(${s}, offset), ${p}).join('');`:`${t} = new TextDecoder('${i}').decode(buffer.subarray(${s}, offset));`));this.options.stripNull&&e.pushCode(`${t} = ${t}.replace(/\\x00+$/g, '')`)}generateBuffer(e){const t=e.generateVariable(this.varName);if(typeof this.options.readUntil=="function"){const s=this.options.readUntil,i=e.generateTmpVariable(),o=e.generateTmpVariable();e.pushCode(`var ${i} = offset;`),e.pushCode(`var ${o} = 0;`),e.pushCode("while (offset < buffer.length) {"),e.pushCode(`${o} = dataView.getUint8(offset);`);const p=e.addImport(s);e.pushCode(`if (${p}.call(${e.generateVariable()}, ${o}, buffer.subarray(offset))) break;`),e.pushCode("offset += 1;"),e.pushCode("}"),e.pushCode(`${t} = buffer.subarray(${i}, offset);`)}else if(this.options.readUntil==="eof")e.pushCode(`${t} = buffer.subarray(offset);`);else{const s=e.generateOption(this.options.length);e.pushCode(`${t} = buffer.subarray(offset, offset + ${s});`),e.pushCode(`offset += ${s};`)}this.options.clone&&e.pushCode(`${t} = buffer.constructor.from(${t});`)}generateArray(e){const t=e.generateOption(this.options.length),s=e.generateOption(this.options.lengthInBytes),i=this.options.type,o=e.generateTmpVariable(),p=e.generateVariable(this.varName),h=e.generateTmpVariable(),d=this.options.key,l=typeof d=="string";if(l?e.pushCode(`${p} = {};`):e.pushCode(`${p} = [];`),typeof this.options.readUntil=="function"?e.pushCode("do {"):this.options.readUntil==="eof"?e.pushCode(`for (var ${o} = 0; offset < buffer.length; ${o}++) {`):s!==void 0?e.pushCode(`for (var ${o} = offset + ${s}; offset < ${o}; ) {`):e.pushCode(`for (var ${o} = ${t}; ${o} > 0; ${o}--) {`),typeof i=="string")if(m.get(i)){const u=e.generateTmpVariable();if(e.pushCode(`var ${u} = ${w+i}(offset, {`),e.useContextVariables){const b=e.generateVariable();e.pushCode(`$parent: ${b},`),e.pushCode(`$root: ${b}.$root,`),!this.options.readUntil&&s===void 0&&e.pushCode(`$index: ${t} - ${o},`)}e.pushCode("});"),e.pushCode(`var ${h} = ${u}.result; offset = ${u}.offset;`),i!==this.alias&&e.addReference(i)}else{const u=E[i],b=I[i];e.pushCode(`var ${h} = dataView.get${u}(offset, ${b});`),e.pushCode(`offset += ${c[i]};`)}else if(i instanceof a){e.pushCode(`var ${h} = {};`);const u=e.generateVariable();e.pushScope(h),e.useContextVariables&&(e.pushCode(`${h}.$parent = ${u};`),e.pushCode(`${h}.$root = ${u}.$root;`),!this.options.readUntil&&s===void 0&&e.pushCode(`${h}.$index = ${t} - ${o};`)),i.generate(e),e.useContextVariables&&(e.pushCode(`delete ${h}.$parent;`),e.pushCode(`delete ${h}.$root;`),e.pushCode(`delete ${h}.$index;`)),e.popScope()}if(l?e.pushCode(`${p}[${h}.${d}] = ${h};`):e.pushCode(`${p}.push(${h});`),e.pushCode("}"),typeof this.options.readUntil=="function"){const u=this.options.readUntil,b=e.addImport(u);e.pushCode(`while (!${b}.call(${e.generateVariable()}, ${h}, buffer.subarray(offset)));`)}}generateChoiceCase(e,t,s){if(typeof s=="string"){const i=e.generateVariable(this.varName);if(m.has(s)){const o=e.generateTmpVariable();e.pushCode(`var ${o} = ${w+s}(offset, {`),e.useContextVariables&&(e.pushCode(`$parent: ${i}.$parent,`),e.pushCode(`$root: ${i}.$root,`)),e.pushCode("});"),e.pushCode(`${i} = ${o}.result; offset = ${o}.offset;`),s!==this.alias&&e.addReference(s)}else{const o=E[s],p=I[s];e.pushCode(`${i} = dataView.get${o}(offset, ${p});`),e.pushCode(`offset += ${c[s]}`)}}else s instanceof a&&(e.pushPath(t),s.generate(e),e.popPath(t))}generateChoice(e){const t=e.generateOption(this.options.tag),s=e.generateVariable(this.varName);if(this.varName&&(e.pushCode(`${s} = {};`),e.useContextVariables)){const i=e.generateVariable();e.pushCode(`${s}.$parent = ${i};`),e.pushCode(`${s}.$root = ${i}.$root;`)}e.pushCode(`switch(${t}) {`);for(const i in this.options.choices){const o=parseInt(i,10),p=this.options.choices[o];e.pushCode(`case ${o}:`),this.generateChoiceCase(e,this.varName,p),e.pushCode("break;")}e.pushCode("default:"),this.options.defaultChoice?this.generateChoiceCase(e,this.varName,this.options.defaultChoice):e.generateError(`"Met undefined tag value " + ${t} + " at choice"`),e.pushCode("}"),this.varName&&e.useContextVariables&&(e.pushCode(`delete ${s}.$parent;`),e.pushCode(`delete ${s}.$root;`))}generateNest(e){const t=e.generateVariable(this.varName);if(this.options.type instanceof a){if(this.varName&&(e.pushCode(`${t} = {};`),e.useContextVariables)){const s=e.generateVariable();e.pushCode(`${t}.$parent = ${s};`),e.pushCode(`${t}.$root = ${s}.$root;`)}e.pushPath(this.varName),this.options.type.generate(e),e.popPath(this.varName),this.varName&&e.useContextVariables&&e.useContextVariables&&(e.pushCode(`delete ${t}.$parent;`),e.pushCode(`delete ${t}.$root;`))}else if(m.has(this.options.type)){const s=e.generateTmpVariable();if(e.pushCode(`var ${s} = ${w+this.options.type}(offset, {`),e.useContextVariables){const i=e.generateVariable();e.pushCode(`$parent: ${i},`),e.pushCode(`$root: ${i}.$root,`)}e.pushCode("});"),e.pushCode(`${t} = ${s}.result; offset = ${s}.offset;`),this.options.type!==this.alias&&e.addReference(this.options.type)}}generateWrapper(e){const t=e.generateVariable(this.varName),s=e.generateTmpVariable();if(typeof this.options.readUntil=="function"){const d=this.options.readUntil,l=e.generateTmpVariable(),u=e.generateTmpVariable();e.pushCode(`var ${l} = offset;`),e.pushCode(`var ${u} = 0;`),e.pushCode("while (offset < buffer.length) {"),e.pushCode(`${u} = dataView.getUint8(offset);`);const b=e.addImport(d);e.pushCode(`if (${b}.call(${e.generateVariable()}, ${u}, buffer.subarray(offset))) break;`),e.pushCode("offset += 1;"),e.pushCode("}"),e.pushCode(`${s} = buffer.subarray(${l}, offset);`)}else if(this.options.readUntil==="eof")e.pushCode(`${s} = buffer.subarray(offset);`);else{const d=e.generateOption(this.options.length);e.pushCode(`${s} = buffer.subarray(offset, offset + ${d});`),e.pushCode(`offset += ${d};`)}this.options.clone&&e.pushCode(`${s} = buffer.constructor.from(${s});`);const i=e.generateTmpVariable(),o=e.generateTmpVariable(),p=e.generateTmpVariable(),h=e.addImport(this.options.wrapper);if(e.pushCode(`${s} = ${h}.call(this, ${s}).subarray(0);`),e.pushCode(`var ${i} = buffer;`),e.pushCode(`var ${o} = offset;`),e.pushCode(`var ${p} = dataView;`),e.pushCode(`buffer = ${s};`),e.pushCode("offset = 0;"),e.pushCode("dataView = new DataView(buffer.buffer, buffer.byteOffset, buffer.length);"),this.options.type instanceof a)this.varName&&e.pushCode(`${t} = {};`),e.pushPath(this.varName),this.options.type.generate(e),e.popPath(this.varName);else if(m.has(this.options.type)){const d=e.generateTmpVariable();e.pushCode(`var ${d} = ${w+this.options.type}(0);`),e.pushCode(`${t} = ${d}.result;`),this.options.type!==this.alias&&e.addReference(this.options.type)}e.pushCode(`buffer = ${i};`),e.pushCode(`dataView = ${p};`),e.pushCode(`offset = ${o};`)}generateFormatter(e,t,s){if(typeof s=="function"){const i=e.addImport(s);e.pushCode(`${t} = ${i}.call(${e.generateVariable()}, ${t});`)}}generatePointer(e){const t=this.options.type,s=e.generateOption(this.options.offset),i=e.generateTmpVariable(),o=e.generateVariable(this.varName);if(e.pushCode(`var ${i} = offset;`),e.pushCode(`offset = ${s};`),this.options.type instanceof a){if(e.pushCode(`${o} = {};`),e.useContextVariables){const p=e.generateVariable();e.pushCode(`${o}.$parent = ${p};`),e.pushCode(`${o}.$root = ${p}.$root;`)}e.pushPath(this.varName),this.options.type.generate(e),e.popPath(this.varName),e.useContextVariables&&(e.pushCode(`delete ${o}.$parent;`),e.pushCode(`delete ${o}.$root;`))}else if(m.has(this.options.type)){const p=e.generateTmpVariable();if(e.pushCode(`var ${p} = ${w+this.options.type}(offset, {`),e.useContextVariables){const h=e.generateVariable();e.pushCode(`$parent: ${h},`),e.pushCode(`$root: ${h}.$root,`)}e.pushCode("});"),e.pushCode(`${o} = ${p}.result; offset = ${p}.offset;`),this.options.type!==this.alias&&e.addReference(this.options.type)}else if(Object.keys(c).indexOf(this.options.type)>=0){const p=E[t],h=I[t];e.pushCode(`${o} = dataView.get${p}(offset, ${h});`),e.pushCode(`offset += ${c[t]};`)}e.pushCode(`offset = ${i};`)}generateSaveOffset(e){const t=e.generateVariable(this.varName);e.pushCode(`${t} = offset`)}}function W(r){const e=621355968000000000n,t=10000n,s=8640000000000000n,p=(BigInt(r)-e)/t;if(p>s)throw new Error("Result exceeds max Date");if(p!==0n)return new Date(Number(p))}g(W,"ticksToDate");const N=a.start().nest({type:a.start().uint16le("type",{assert:264}).uint8("data",{formatter:r=>!!r}),formatter:r=>r.data}),Z=a.start().nest({type:a.start().uint16le("type",{assert:2056}).buffer("data",{length:4,formatter:r=>r.toString("binary")})}),$=a.start().nest({type:a.start().uint16("Check",{assert:2056}).uint32le("data"),formatter:r=>r.data||void 0}),T=a.start().nest({type:a.start().uint16le("type",{assert:3336}).uint64le("data",{formatter:r=>r===0n?void 0:W(r)}),formatter:r=>r.data}),C=a.start().useContextVars(!0).nest({type:a.start().buffer("offset",{length:3,formatter:r=>G.decodeULEB128(new Uint8Array(r))}).seek(function(...r){return this.offset[1]-3}).string("string",{length:function(){return Number(this.offset[0])}}),formatter:function(r){return r.string||void 0}}),f=a.start().useContextVars().nest({type:a.start().uint8("fieldType",{assert:r=>r===6||r===9}).uint32le("fieldID").choice("data",{tag:"fieldType",choices:{6:a.start().nest({type:C}),9:a.start()}}),formatter:r=>{if(!M.emptyObject(r.data))return r.data}}),V=a.start().nest({type:a.start().int8("marker").int8("id").int32le("unknown1").int32le("unknown2").int32le("length").seek(1).array("spacers",{type:f,length:"length"}),formatter:r=>r.length}),z=a.start().nest({type:a.start().uint8("marker",{assert:16}).uint32le("recordId").uint32le("fieldCount"),formatter:()=>({})}),Q=a.start().seek(22).nest("assembly",{type:C}).seek(5).nest("class",{type:C}).uint32le("tableCount").array("tableNames",{type:C,length:"tableCount"}).seek("tableCount").array("tableTypes",{type:C,length:"tableCount",formatter:()=>{}}).seek(4).array("tableSpacer",{type:f,length:"tableCount",formatter:()=>{}}).nest("optionsRows",{type:V}).nest("moodsRows",{type:V}).nest("userpicsRows",{type:V}).nest("usersRows",{type:V}).nest("eventsRows",{type:V}).nest("commentsRows",{type:V}),Y=a.start().seek(5).nest("serializer",{type:C}).seek(4).nest("data",{type:C}).nest("unity",{type:C}).nest("assembly",{type:C}).seek(4),x=a.start().nest({type:z}).nest("server",{type:f}).nest("defaultUserPic",{type:f}).nest("fullName",{type:f}).nest("userName",{type:f}).nest("passwordHash",{type:f}).nest("lastSynced",{type:T}).nest("unknown",{type:N}),ee=a.start().nest({type:z}).nest("id",{type:$}).nest("name",{type:f}).nest("parentId",{type:$}),te=a.start().nest({type:z}).nest("keyword",{type:f}).nest("url",{type:f}),se=a.start().nest({type:z}).nest("id",{type:$}).nest("name",{type:f}),re=a.start().nest({type:a.start().nest({type:z}).nest("id",{type:$}).nest("date",{type:T}).nest("security",{type:f}).nest("audience",{type:Z}).nest("subject",{type:f}).nest("body",{type:f}).nest("unknown1",{type:f}).nest("mood",{type:f}).nest("moodId",{type:$}).nest("music",{type:f}).nest("isPreformatted",{type:N}).nest("noComments",{type:N}).nest("userPicKeyword",{type:f}).nest("unknown2",{type:N}).nest("isBackdated",{type:N}).nest("noEmail",{type:N}).nest("unknown2",{type:N}).nest("revision",{type:$}).nest("commentAlter",{type:$}).nest("syndicationId",{type:f}).nest("syndicationUrl",{type:f}).nest("lastModified",{type:T})}),ne=a.start().useContextVars().nest({type:a.start().nest({type:z}).nest("id",{type:$}).nest("userId",{type:$}).nest("userName",{type:f}).nest("eventId",{type:$}).nest("parentId",{type:$}).nest("body",{type:f}).nest("subject",{type:f}).nest("date",{type:T})}),j=a.start().endianess("little").nest("header",{type:Q}).nest("options",{type:x}).array("moods",{type:ee,length:function(){return this.header.moodsRows}}).array("userPics",{type:te,length:function(){return this.header.userpicsRows}}).array("users",{type:se,length:function(){return this.header.usersRows}}).array("events",{type:re,length:function(){return this.header.eventsRows}}).array("comments",{type:ne,length:function(){return this.header.commentsRows}}).nest("footer",{type:Y}),ie=n.z.object({defaultUserPic:n.z.string().url().optional(),userName:n.z.string(),fullName:n.z.string()}),oe=n.z.object({id:n.z.number(),name:n.z.string(),parentId:n.z.number().optional()}),ae=n.z.object({id:n.z.number().default(0),name:n.z.string()}),ue=n.z.object({id:n.z.number(),date:n.z.coerce.date(),security:n.z.string().optional(),audience:n.z.string().optional(),subject:n.z.string().optional(),body:n.z.string().optional(),mood:n.z.string().optional(),moodId:n.z.number().optional(),music:n.z.string().optional(),isPreformatted:n.z.boolean().optional(),noComments:n.z.boolean().optional(),userPicKeyword:n.z.string().optional(),isBackdated:n.z.boolean().optional(),noEmail:n.z.boolean().optional(),revision:n.z.number().optional(),commentAlter:n.z.number().optional(),syndicationId:n.z.string().optional(),syndicationUrl:n.z.string().optional(),lastModified:n.z.coerce.date().optional()}),pe=n.z.object({id:n.z.number(),userId:n.z.number().default(0),userName:n.z.string().optional(),eventId:n.z.number(),parentId:n.z.number().optional(),body:n.z.string().optional(),subject:n.z.string().optional(),date:n.z.coerce.date()}),O=n.z.object({options:ie,moods:n.z.array(oe.optional().catch(()=>{})).transform(r=>r.filter(e=>e!==void 0)),users:n.z.array(ae.optional().catch(()=>{})).transform(r=>r.filter(e=>e!==void 0)),events:n.z.array(ue.optional().catch(()=>{})).transform(r=>r.filter(e=>e!==void 0)),comments:n.z.array(pe.optional().catch(()=>{})).transform(r=>r.filter(e=>e!==void 0))});function he(r){const e=j.parse(r);return O.parse(e)}g(he,"parse$2");var fe=Object.freeze({__proto__:null,file:j,parse:he,schema:O});const U={parse:function(r,e={}){return new J.XMLParser(e).parse(r.toString())}};function P(r){return r.or(n.z.array(r)).transform(e=>e!==void 0&&Array.isArray(e)?e:[e])}g(P,"oneOrMany");const S=n.z.string().transform(r=>H(r).toDate()),le=n.z.object({itemid:n.z.number(),parentId:n.z.number().optional(),event:n.z.string().optional(),eventtime:S,author:n.z.object({name:n.z.string(),email:n.z.string().optional()})}),de=n.z.object({itemid:n.z.number(),eventtime:S,subject:n.z.string().optional(),event:n.z.string().optional(),current_mood:n.z.string().optional(),current_music:n.z.string().optional(),comment:P(le).optional()}),R=n.z.object({livejournal:n.z.object({entry:P(de)})});function be(r){const e=U.parse(r);return R.parse(e)}g(be,"parse$1");var ge=Object.freeze({__proto__:null,file:U,parse:be,schema:R});const v=a.start().nest({type:a.start().uint16le("mark").seek(1).uint8("length",{formatter:r=>r*2}).choice("data",{tag:"length",choices:{510:a.start().nest({type:a.start().uint16le("length",{formatter:r=>r*2}).string("string",{length:"length",encoding:"utf-16le"})}),0:a.start()},defaultChoice:a.start().nest({type:a.start().seek(-1).uint8("length",{formatter:r=>r*2}).string("string",{length:"length",encoding:"utf-16le"})})}),formatter:r=>r.data?.string||void 0}),F=a.start().nest({type:a.start().uint32le("data",{formatter:r=>new Date(r*1e3)}),formatter:r=>r.data}),A=a.start().endianess("little").uint16le("check1",{assert:65535}).uint16le("check2",{assert:8}).uint16le("check3",{assert:6}).string("typeCode",{length:10,stripNull:!0,assert:"CEntry"}).array("unknownStrings",{type:v,length:11}).int32le("id").int32le("unknown1").nest("userName",{type:v}).nest("fullName",{type:v}).nest("body",{type:v}).nest("subject",{type:v}).int32le("unknown2").int32le("unknown3").nest("date",{type:F}).int32le("unknown4").nest("music",{type:v}).nest("mood",{type:v}).int32le("moodId").nest("userPic",{type:v}),B=n.z.object({id:n.z.number(),date:n.z.date(),userName:n.z.string().optional(),fullName:n.z.string().optional(),subject:n.z.string().optional(),body:n.z.string().optional(),mood:n.z.string().optional(),music:n.z.string().optional(),userPic:n.z.string().optional()});function ye(r){const e=A.parse(r);return B.parse(e)}g(ye,"parse");var me=Object.freeze({__proto__:null,file:A,parse:ye,schema:B,timestamp:F});function ce(r,e=!1){const t=/<lj-cut(?:\s+text=([^>]*))?>/is,s=/<\/lj-cut>/is;let i=t.exec(r)??void 0;const o={};if(!i)o.preCut=e?r.trim():r;else{let p=i[1]?.replaceAll(/(^['"]|['"]$)/g,""),[h,d]=r.split(i[0]),l,u;s.test(d)?[l,u]=d.split(s):u=d,h=e?h?.trim():h,p=e?p?.trim():p,l=e?l?.trim():l,u=e?u?.trim():u,h&&(o.preCut=h),p&&(o.cutText=p),l&&(o.hiddenText=l),u&&(o.postCut=u)}return{...o}}g(ce,"parseCutTag");function $e(r){const e=r.matchAll(/<lj user=['"]?(\w*)['"]?[^>]*>/gi)??[];return Object.fromEntries([...e].map(t=>[t[0],t[1]]))}g($e,"parseUserTags"),exports.lja=fe,exports.parseCutTag=ce,exports.parseUserTags=$e,exports.slj=me,exports.xml=ge;
